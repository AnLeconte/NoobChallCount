<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NoobChallCount</title>
  <!-- Inclure Bootstrap CSS -->
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <!-- Inclure Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .counter {
      margin-bottom: 20px;
    }

    /* Styles pour positionner l'image */
    #dofusEmeraude {
      position: fixed;
      bottom: 10px; /* Ajuster selon votre besoin */
      right: 10px; /* Ajuster selon votre besoin */
      width: 100px; /* Ajuster la taille de l'image */
      height: auto; /* Pour garder les proportions */
      z-index: 1000; /* Assure que l'image soit au-dessus du contenu */
    }

    /* Ajout d'une couleur de fond temporaire pour déboguer */
    body {
      background-color: #f8f9fa; /* Couleur de fond temporaire */
    }

    .container {
      background-color: #ffffff; /* Couleur de fond du conteneur principal */
      padding: 20px; /* Ajouter un peu d'espace autour du contenu */
      margin-top: 20px; /* Ajuster selon votre besoin */
    }

    /* Rétablissement des styles pour le tableau et les textes */
    .table {
      margin-top: 20px; /* Espacement entre le haut du conteneur et le tableau */
    }

    .modal-content {
      background-color: #ffffff; /* Couleur de fond de la modal */
    }

    /* Styles pour positionner les boutons */
    .buttons-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
    }

    .reset-button {
      margin-top: 10px; /* Espacement supplémentaire après les textes de sauvegarde */
    }
  </style>
</head>
<body>
<div class="container">
  <div class="d-flex flex-column align-items-center my-4">
    <h1>Ajouter un noob</h1>
    <div class="d-flex mb-4">
      <input type="text" id="buttonName" placeholder="Nom du noob" class="form-control mr-2">
      <button id="createButton" class="btn btn-primary">Ajouter le noob</button>
    </div>
  </div>

  <table class="table table-striped">
    <thead>
    <tr>
      <th>Nom du noob</th>
      <th>Challenges foirés</th>
      <th>+1</th>
    </tr>
    </thead>
    <tbody id="countersContainer"></tbody>
  </table>

  <!-- Bouton Enregistrer -->
  <div class="text-right">
    <button id="saveButton" class="btn btn-success">Enregistrer</button>
  </div>

  <!-- Textes de sauvegarde -->
  <div id="saveText" class="mt-3"></div>

  <!-- Bouton Réinitialiser les sauvegardes -->
  <div class="reset-button">
    <button id="resetButton" class="btn btn-danger">Réinitialiser les sauvegardes</button>
  </div>

  <div class="mt-5">
    <canvas id="challengesChart"></canvas>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Sauvegarde réussie</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>Le plus gros noob est : <span id="topNoobName"></span> avec <span id="topNoobCount"></span> challenges foirés.</p>
          <p>Date de sauvegarde : <span id="saveDate"></span></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Image de Dofus Émeraude -->
  <img id="dofusEmeraude" src="img/dfs02-emeraude_orig.png" alt="Dofus Émeraude">
</div>

<!-- Inclure Bootstrap JS et ses dépendances -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
  let counterId = 1; // Identifiant pour les compteurs
  const countersContainer = document.getElementById('countersContainer');
  const createButton = document.getElementById('createButton');
  const saveButton = document.getElementById('saveButton');
  const resetButton = document.getElementById('resetButton');
  const saveTextContainer = document.getElementById('saveText');

  let counters = []; // Tableau pour stocker les compteurs
  let savedRecords = []; // Tableau pour stocker les enregistrements sauvegardés

  // Charger les enregistrements depuis localStorage s'ils existent
  if (localStorage.getItem('savedRecords')) {
    savedRecords = JSON.parse(localStorage.getItem('savedRecords'));
    displaySavedRecords();
  }

  createButton.addEventListener('click', () => {
    const buttonName = document.getElementById('buttonName').value;
    if (buttonName.trim() === '') {
      alert('Veuillez entrer un nom pour le noob.');
      return;
    }
    addCounter(buttonName);
    document.getElementById('buttonName').value = ''; // Réinitialiser le champ de saisie
  });

  saveButton.addEventListener('click', () => {
    const maxCount = Math.max(...counters.map(counter => counter.count));
    const topCounter = counters.find(counter => counter.count === maxCount);
    const currentDate = new Date().toLocaleString(); // Obtenir la date actuelle

    // Créer un nouvel enregistrement
    const record = {
      name: topCounter.name,
      count: topCounter.count,
      date: currentDate
    };

    // Ajouter l'enregistrement au tableau des enregistrements
    savedRecords.push(record);

    // Sauvegarder les enregistrements dans localStorage
    localStorage.setItem('savedRecords', JSON.stringify(savedRecords));

    // Afficher le dernier enregistrement sauvegardé
    document.getElementById('topNoobName').textContent = record.name;
    document.getElementById('topNoobCount').textContent = record.count;
    document.getElementById('saveDate').textContent = record.date;
    $('#exampleModal').modal('show'); // Afficher la modal

    // Afficher tous les enregistrements sauvegardés
    displaySavedRecords();
  });

  resetButton.addEventListener('click', () => {
    // Réinitialiser les sauvegardes visuelles
    saveTextContainer.innerHTML = '';
    // Réinitialiser le tableau des enregistrements
    savedRecords = [];
    // Supprimer les sauvegardes du localStorage
    localStorage.removeItem('savedRecords');

    // Mettre à jour le graphique après réinitialisation
    updateChallengesChart();
  });

  function displaySavedRecords() {
    saveTextContainer.innerHTML = ''; // Effacer le contenu actuel

    savedRecords.forEach(record => {
      const saveText = document.createElement('p');
      saveText.textContent = `Sauvegarde pour ${record.name} : ${record.count} challenges foirés, le ${record.date}`;
      saveTextContainer.appendChild(saveText);
    });

    // Mettre à jour le graphique après chaque ajout de sauvegarde
    updateChallengesChart();
  }

  function addCounter(buttonName) {
    // Créer les éléments pour un nouveau compteur
    const counterRow = document.createElement('tr');
    const nameCell = document.createElement('td');
    nameCell.textContent = buttonName;

    const countCell = document.createElement('td');
    const countP = document.createElement('p');
    countP.textContent = '0';
    countCell.appendChild(countP);

    const actionCell = document.createElement('td');
    const addButton = document.createElement('button');
    addButton.textContent = '+1';
    addButton.classList.add('btn', 'btn-secondary');
    actionCell.appendChild(addButton);

    // Ajouter les cellules à la ligne
    counterRow.appendChild(nameCell);
    counterRow.appendChild(countCell);
    counterRow.appendChild(actionCell);

    // Ajouter la ligne au tableau
    countersContainer.appendChild(counterRow);

    // Gestion de l'ID pour chaque compteur
    const counterId = counters.length + 1;

    // Ajouter le compteur à la liste des compteurs
    counters.push({ id: counterId, name: buttonName, count: 0 });

    // Ajouter un gestionnaire d'événements pour le bouton +1
    addButton.addEventListener('click', () => {
      // Trouver l'index du compteur dans le tableau counters
      const index = counters.findIndex(counter => counter.id === counterId);
      // Incrémenter le compteur pour ce compteur spécifique
      counters[index].count++;
      // Mettre à jour l'affichage du compteur dans le DOM
      countP.textContent = counters[index].count.toString();

      // Mettre à jour le graphique à chaque clic sur le bouton +1
      updateChallengesChart();
    });
  }


  function updateChallengesChart() {
    // Récupérer tous les noms de noob uniques
    const uniqueNames = [...new Set(counters.map(counter => counter.name))];

    // Initialiser un tableau pour les totaux de challenges foirés par noob
    const challengesData = uniqueNames.map(name => {
      return {
        name: name,
        total: counters.filter(counter => counter.name === name).reduce((acc, curr) => acc + curr.count, 0)
      };
    });

    // Extraire les noms et les totaux pour le graphique
    const names = challengesData.map(data => data.name);
    const totals = challengesData.map(data => data.total);

    // Couleurs pré-définies pour chaque barre du graphique
    const colors = [
      'rgba(255, 99, 132, 0.2)', // Rouge
      'rgba(54, 162, 235, 0.2)', // Bleu
      'rgba(255, 206, 86, 0.2)', // Jaune
      'rgba(75, 192, 192, 0.2)', // Vert
      'rgba(153, 102, 255, 0.2)', // Violet
      'rgba(255, 159, 64, 0.2)'  // Orange
    ];

    // Configuration des couleurs pour chaque barre du graphique
    const backgroundColors = names.map((name, index) => colors[index % colors.length]);

    // Configuration du graphique avec Chart.js
    const ctx = document.getElementById('challengesChart').getContext('2d');
    if (window.myChart instanceof Chart) {
      window.myChart.destroy(); // Détruire l'instance précédente du graphique pour éviter les doublons
    }
    window.myChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: names,
        datasets: [{
          label: 'Challenges foirés',
          data: totals,
          backgroundColor: backgroundColors,
          borderColor: 'rgba(0, 0, 0, 1)',
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Nombre de challenges foirés'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Noob'
            }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                // Récupérer le nom du noob à partir de l'index context.datasetIndex et context.dataIndex
                const name = names[context.dataIndex];
                // Récupérer le nombre de challenges foirés
                const count = context.raw;
                return `${name}: ${count} challenges foirés`;
              }
            }
          }
        }
      }
    });
  }
</script>
</body>
</html>
